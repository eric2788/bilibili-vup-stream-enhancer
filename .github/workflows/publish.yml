name: Publish Extensions
on:
    workflow_dispatch:
      inputs:
        dry-run:
          description: 'dry run mode, will upload to the store but not publish'
          type: boolean
          required: false
          default: true

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                browser: [chrome, edge]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v2
              with:
                version: 8
            - name: Setup Node.js
              uses: actions/setup-node@v4.0.1
              with:
                  node-version: 20
                  cache: 'pnpm'
            - name: Install dependencies
              run: pnpm install --frozen-lockfile
            - name: Build And Package Extensions
              run: pnpm build --zip --target=${{ matrix.browser }}-mv3
            - name: Upload to GitHub Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.browser }}-mv3.zip
                  path: build/
    publish-chrome:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: build/
            - name: Upload & release
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                file-path: build/chrome-mv3.zip
                extension-id: nhomlepkjglilcahfcfnggebkaabeiog
                client-id: ${{ secrets.CHROME_CLIENT_ID }}
                client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
                refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
                publish: ${{ !inputs.dry-run }}
    publish-edge:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                path: build/
            - uses: wdzeng/edge-addon@v1
              with:
                product-id: ${{ secrets.EDGE_PRODUCT_ID }}
                zip-path: build/edge-mv3.zip
                client-id: ${{ secrets.EDGE_CLIENT_ID }}
                client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
                access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
                upload-only: ${{ inputs.dry-run }}